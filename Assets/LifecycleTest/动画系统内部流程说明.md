# Unity 动画系统内部流程说明

## Write Transform 和 WriteProperties 详解

在 Unity 的生命周期执行顺序图中，**Write Transform** 和 **WriteProperties** 是动画系统内部的函数，用于将动画计算的结果应用到场景中的对象。

### Write Transform（写入变换）

**作用**：
- 将动画计算得到的**变换数据**（位置、旋转、缩放）从**工作线程**写入到场景中的对象 **Transform** 组件
- 这是动画系统将计算结果应用到场景的关键步骤

**执行时机**：
- 在动画系统评估（Evaluate）完成后
- 在 `LateUpdate` 之后
- 在 `OnAnimatorMove` 之前

**工作原理**：
1. 动画系统在工作线程中计算动画的变换值（position, rotation, scale）
2. `Write Transform` 将这些值从工作线程同步到主线程
3. 更新场景中对象的 `Transform` 组件

**为什么需要这个步骤**：
- Unity 的动画系统使用多线程优化性能
- 动画计算在工作线程中进行，但 Transform 的修改必须在主线程
- `Write Transform` 负责线程间的数据同步

### WriteProperties（写入属性）

**作用**：
- 从**主线程**将所有**其他动画属性**写入到场景中的相应组件
- 这些属性包括：
  - 材质属性（Material properties）
  - 灯光强度（Light intensity）
  - 其他非 Transform 的动画属性

**执行时机**：
- 在 `Write Transform` 之后
- 在 `OnAnimatorMove` 之前

**工作原理**：
1. 动画系统计算所有非 Transform 的属性值
2. `WriteProperties` 将这些值应用到相应的组件
3. 例如：动画可能改变材质的颜色、灯光的强度等

## 完整的动画系统执行流程

```
LateUpdate
  ↓
动画系统评估 (Animation Evaluation)
  - 在工作线程中计算动画值
  - 计算 Transform（位置、旋转、缩放）
  - 计算其他属性（材质、灯光等）
  ↓
Write Transform
  - 将 Transform 数据从工作线程同步到主线程
  - 更新场景中对象的 Transform 组件
  ↓
WriteProperties
  - 将其他属性值应用到相应组件
  - 更新材质、灯光等属性
  ↓
OnAnimatorMove
  - MonoBehaviour 回调
  - 可以处理根运动（Root Motion）
  ↓
OnAnimatorIK
  - MonoBehaviour 回调
  - IK（反向运动学）处理
```

## 为什么这些步骤很重要

### 1. 性能优化
- 动画计算在工作线程进行，不阻塞主线程
- 只有最终的写入操作在主线程执行

### 2. 数据一致性
- 确保所有动画数据在同一时刻写入
- 避免部分更新导致的不一致状态

### 3. 执行顺序保证
- `Write Transform` 和 `WriteProperties` 在 `LateUpdate` 之后执行
- 确保所有脚本的 `Update` 和 `LateUpdate` 都已完成
- 动画结果在 `OnAnimatorMove` 之前就已经应用到场景

## 实际应用场景

### 场景1：在 LateUpdate 中读取 Transform
```csharp
void LateUpdate()
{
    // 此时 Transform 还没有被动画系统更新
    // 读取的是上一帧的值
}

void OnAnimatorMove()
{
    // 此时 Transform 已经被 Write Transform 更新
    // 可以读取到最新的动画值
}
```

### 场景2：根运动处理
```csharp
void OnAnimatorMove()
{
    // Write Transform 已经完成
    // 可以安全地处理根运动
    Vector3 deltaPosition = animator.deltaPosition;
    Quaternion deltaRotation = animator.deltaRotation;
    
    // 应用根运动
    transform.position += deltaPosition;
    transform.rotation *= deltaRotation;
}
```

## 注意事项

1. **线程安全**：
   - `Write Transform` 和 `WriteProperties` 是 Unity 内部的线程同步点
   - 开发者不需要手动处理线程同步

2. **执行顺序**：
   - 这些步骤在 `LateUpdate` 之后自动执行
   - 无法通过脚本直接访问或修改这些步骤

3. **性能考虑**：
   - 这些步骤是动画系统的核心，已经高度优化
   - 避免在 `OnAnimatorMove` 中进行大量计算

4. **与 StateMachineBehaviour 的关系**：
   - `OnStateEnter/Update/Exit` 在动画评估阶段调用
   - `Write Transform` 在状态机回调之后执行
   - 因此状态机回调中修改 Transform 可能会被动画覆盖

## 总结

- **Write Transform**：将动画计算的 Transform 数据从工作线程写入到主线程的 Transform 组件
- **WriteProperties**：将动画计算的其他属性值应用到相应组件
- 这两个步骤是 Unity 动画系统的内部机制，确保动画结果正确应用到场景
- 它们在 `LateUpdate` 之后、`OnAnimatorMove` 之前执行
- 开发者通常不需要直接操作这些步骤，但了解它们有助于理解动画系统的执行流程


